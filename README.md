# md-roam-server

HTTP REST API server that exposes org-roam and md-roam functionality for building applications on top of your org-roam knowledge base.

## Features

- **Complete CRUD Operations**: Create, read, update, and delete nodes with file format selection (.md/.org)
- **Full Metadata Support**: Complete metadata for Markdown files (tags, aliases, refs, category)
- **Basic Metadata Support**: Essential metadata for Org files (category, simplified tags/aliases/refs)
- **Bidirectional Links**: org-roam's signature backlink and forward link discovery
- **Unified File Support**: Both Org-mode (.org) and Markdown (.md) files via [md-roam](https://github.com/nobiot/md-roam)
- **Database-Driven**: Uses org-roam SQLite database for fast queries and search
- **Advanced Search**: Search by title, alias, tags, references, citations with database optimization
- **Advanced Parsing**: Separates metadata from content for both YAML front matter and Org properties
- **Citation Support**: Extracts and tracks citations in `[@citation-key]` and `[[cite:citation-key]]` formats  
- **Statistics Dashboard**: Comprehensive database statistics and health metrics
- **Snake_case Responses**: Consistent JSON field naming across all endpoints
- **Visual Graph Interface**: Integrated [org-roam-ui](https://github.com/org-roam/org-roam-ui) for interactive knowledge graph visualization
- **Daemon Mode**: Stable server operation with automatic startup/shutdown scripts
- **Production Ready**: Persistent server with proper process management and error handling
- **Configuration File Support**: YAML-based configuration for ports and directories via `~/.config/md-roam-server/config.yml`

## Setup

### Docker Setup (Recommended)

The easiest way to run md-roam-server is using Docker. This provides a consistent environment with all dependencies pre-installed.

1. **Quick Start with Docker:**
```bash
# Build and start the server
make dev

# Or manually:
docker-compose up --build -d
```

2. **Access the services:**
- **REST API**: http://localhost:8080
- **Graph UI**: http://localhost:35901 (org-roam-ui)

3. **Stop the server:**
```bash
make stop

# Or manually:
docker-compose down
```

### Docker with Local org-roam Directory

To use your existing org-roam notes:

1. **Copy and customize docker-compose configuration:**
```bash
cp docker-compose.local.yml docker-compose.override.yml
# Edit docker-compose.override.yml to point to your org-roam directory
```

2. **Example docker-compose.override.yml:**
```yaml
version: '3.8'

services:
  md-roam-server:
    volumes:
      - /path/to/your/org-roam:/data/org-roam
      - /path/to/your/.config/md-roam-server:/root/.config/md-roam-server
```

3. **Start with your configuration:**
```bash
docker-compose up -d
```

### Native Nix Setup

For development or if you prefer running natively:

1. Enter the Nix development environment:
```bash
nix develop
```

2. Start the server:

### Quick Start (Native)
```bash
# Start server in daemon mode (most stable)
./start.sh

# Stop server
./stop.sh
```

The server will start in daemon mode and provide access to:
- **REST API**: http://localhost:8080
- **Graph UI**: http://localhost:35901 (org-roam-ui)

### Manual Start Options

**Daemon Mode (Production Ready):**
```bash
# Start daemon with all features
nix develop -c bash -c "cd . && emacs --daemon --eval \"(progn (add-to-list 'load-path \".\" ) (load-file \"md-roam-server.el\") (md-roam-server-start) (message \"md-roam server started in daemon mode\"))\""

# Check if running
curl -s http://localhost:8080/stats

# Stop daemon gracefully
nix develop -c emacsclient -e "(md-roam-server-stop)" && pkill -f "emacs.*daemon"
```

**Interactive Development Mode:**
```bash
# For development and debugging
nix develop -c emacs -l md-roam-server.el
# Then run: M-x md-roam-server-start
```

## Configuration

The server supports configuration via a YAML file. The configuration file path can be specified at startup, otherwise it defaults to `~/.config/md-roam-server/config.yml`.

### Configuration File Location

**Default location:**
```
~/.config/md-roam-server/config.yml
```

**Custom location via environment variable:**
```bash
export MD_ROAM_CONFIG_FILE=/path/to/custom/config.yml
```

**Custom location via command line:**
```bash
# Native environment
./start.sh --config /path/to/custom/config.yml

# Docker environment
./docker/start.sh --config /path/to/custom/config.yml

# Makefile
make dev-config CONFIG=/path/to/custom/config.yml
make start-config CONFIG=/path/to/custom/config.yml
```

### Default Configuration
```yaml
# md-roam-server configuration file
# This file is automatically generated. Edit to customize settings.

server:
  port: 8080                    # REST API port
  ui-port: 35901                # org-roam-ui web interface port
  ui-enabled: true              # Enable org-roam-ui integration

org-roam:
  directory: ~/org-roam         # Path to org-roam notes directory
  # db-location: nil            # Custom database location (optional)
```

### Configuration Options

**Server Settings:**
- `server.port` - REST API server port (default: 8080)
- `server.ui-port` - org-roam-ui web interface port (default: 35901)
- `server.ui-enabled` - Enable/disable org-roam-ui integration (default: true)

**org-roam Settings:**
- `org-roam.directory` - Path to your org-roam notes directory (default: ~/org-roam)
- `org-roam.db-location` - Custom database location (optional, defaults to org-roam standard location)

### Markdown File Support

md-roam-server provides full support for Markdown (.md) files alongside Org-mode (.org) files through [md-roam](https://github.com/nobiot/md-roam). To ensure proper recognition, Markdown files should include YAML front matter:

**Example Markdown file format:**
```markdown
---
title: My Note Title
id: unique-node-id
tags: [research, important]
aliases: ["Alternative Name"]
roam_refs: https://example.com
---

# My Note Title

Your note content goes here.

## Section Headers
- Bullet points work
- [[Links to other notes]] work
- #hashtags work

Links to other nodes: [[another-note-id]]
References: [@citation-key] or [[cite:citation-key]]
```

**Required front matter fields:**
- `title` - The note title
- `id` - Unique identifier for the node

**Optional front matter fields:**
- `tags` - Array of tags for categorization
- `aliases` - Array of alternative names for the note
- `roam_refs` - External references (URLs, etc.)
- `category` - Category string (e.g., "#research #important")

### Applying Configuration Changes

After modifying the configuration file, restart the server to apply changes:
```bash
./stop.sh && ./start.sh
```

### Configuration API Endpoint

Check current configuration:
```bash
# Get current server configuration
curl http://localhost:8080/config
```

## Docker Environment

### Available Docker Commands (via Makefile)

```bash
# Development commands
make dev          # Start development server with hot reload
make build        # Build Docker image
make start        # Start container in detached mode
make stop         # Stop and remove container
make logs         # View container logs
make shell        # Open shell in running container

# Cleanup commands
make clean        # Remove containers and images
make prune        # Clean up Docker system
```

### Docker Configuration Files

- **`Dockerfile`** - Multi-stage production build with Nix environment
- **`Dockerfile.simple`** - Single-stage development build for faster iteration
- **`docker-compose.yml`** - Default Docker Compose configuration
- **`docker-compose.local.yml`** - Example for mounting local org-roam directories

### Container Architecture

The Docker container runs a complete md-roam-server environment:
- **Base**: nixos/nix image with Nix package manager
- **Dependencies**: Emacs, org-roam, md-roam, org-roam-ui
- **Networking**: Exposed ports 8080 (API) and 35901 (UI)
- **Volumes**: Configurable for org-roam directory and configuration
- **Health Checks**: Automatic monitoring of server status

### Development Workflow

1. **Make changes to elisp/ files**
2. **Rebuild and restart:**
   ```bash
   make dev  # This rebuilds and restarts automatically
   ```
3. **Check logs:**
   ```bash
   make logs
   ```
4. **Debug in container:**
   ```bash
   make shell
   emacs --batch --eval "(require 'md-roam-server)"
   ```

## API Overview

The server provides a comprehensive REST API with the following categories of endpoints:

### File Operations
- `GET /files` - List all org-roam nodes with metadata
- `GET /files/raw` - List physical files in org-roam directory
- `GET /files/content/:filepath` - Get file content by filepath

### Node Operations
- `GET /nodes` - List all nodes with metadata
- `GET /nodes/:id` - Get single node metadata
- `GET /nodes/:id/content` - Get complete file content by node ID
- `GET /nodes/:id/parse` - Parse file and separate metadata from body
- `POST /nodes` - Create new node
- `PUT /nodes/:id` - Update existing node
- `DELETE /nodes/:id` - Delete node and file

### Node Relationships
- `GET /nodes/:id/backlinks` - Get nodes that link to this node
- `GET /nodes/:id/links` - Get nodes this node links to
- `GET /nodes/:id/aliases` - Get node aliases
- `GET /nodes/:id/refs` - Get node references

### Node Tag Management
- `POST /nodes/:id/tags` - Add a tag to a node
- `DELETE /nodes/:id/tags/:tag` - Remove a tag from a node

### Node Category Management
- `POST /nodes/:id/categories` - Add a category to a node
- `DELETE /nodes/:id/categories/:category` - Remove a category from a node

### Search & Discovery
- `GET /search/:query` - Search nodes by title or alias
- `GET /tags/:tag/nodes` - Get nodes with specific tag
- `GET /aliases/:alias/nodes` - Get nodes with specific alias
- `GET /refs/:ref/nodes` - Get nodes with specific reference
- `GET /citations/:citation/nodes` - Get nodes with specific citation

### Metadata Collections
- `GET /tags` - List all tags with usage counts
- `GET /aliases` - List all aliases with usage counts  
- `GET /refs` - List all references with usage counts
- `GET /citations` - List all citations with usage counts
- `GET /stats` - Get comprehensive database statistics
- `GET /config` - Get server configuration and settings
- `GET /ui` - Get org-roam-ui server status and configuration

### Database Management
- `POST /sync` - Synchronize org-roam database

## API Endpoints

### GET /files
Returns a list of all org-roam files with metadata.

**Response:**
```json
{
  "files": [
    {
      "id": "node-id",
      "title": "Node Title",
      "file": "/path/to/file.org",
      "level": 0,
      "tags": ["tag1", "tag2"],
      "aliases": ["alias1"]
    }
  ],
  "count": 1
}
```

### GET /files/raw
Returns a list of physical files in the org-roam directory with file metadata.

**Response:**
```json
{
  "status": "success",
  "message": "Found 20 files in org-roam directory",
  "timestamp": "2024-01-01 12:00:00",
  "directory": "/Users/user/org-roam/",
  "files": [
    {
      "name": "20240101120000-example_note.md",
      "path": "/Users/user/org-roam/20240101120000-example_note.md",
      "extension": "md",
      "size": 256,
      "modified": "2024-01-01 12:00:00",
      "created": "2024-01-01 12:00:00"
    }
  ],
  "count": 20
}
```

### GET /files/content/:filepath
Returns the content of a specific file by its relative filepath.

**Parameters:**
- `filepath` (path parameter) - The relative path to the file from org-roam directory

**Response (Success):**
```json
{
  "status": "success",
  "message": "File content retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "path": "20240101120000-example_note.md",
  "full_path": "/Users/user/org-roam/20240101120000-example_note.md",
  "size": 256,
  "modified": "2024-01-01 12:00:00",
  "content": "---\nid: example-id\ntitle: Example Note\n---\n\nThis is the content of the file."
}
```

**Response (404 - File Not Found):**
```json
{
  "status": "error",
  "message": "Error reading file 'nonexistent.md': File not found or access denied",
  "timestamp": "2024-01-01 12:00:00",
  "filepath": "nonexistent.md",
  "directory": "/Users/user/org-roam/"
}
```

### GET /tags
Returns a list of all unique tags used across org-roam nodes with usage counts and the node IDs that use each tag.

**Response:**
```json
{
  "status": "success",
  "message": "Tags retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "tags": [
    {
      "tag": "research",
      "count": 3,
      "node_ids": ["node-id-1", "node-id-2", "node-id-3"]
    },
    {
      "tag": "project",
      "count": 2,
      "node_ids": ["node-id-4", "node-id-5"]
    }
  ],
  "total_tags": 2
}
```

### GET /aliases
Returns a list of all unique aliases used across org-roam nodes with usage counts and the node IDs that use each alias.

**Response:**
```json
{
  "status": "success",
  "message": "Aliases retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "aliases": [
    {
      "alias": "Research Paper",
      "count": 2,
      "node_ids": ["node-id-1", "node-id-3"]
    },
    {
      "alias": "Project Notes",
      "count": 1,
      "node_ids": ["node-id-4"]
    }
  ],
  "total_aliases": 2
}
```

### GET /refs
Returns a list of all unique refs used across org-roam nodes with usage counts and the node IDs that use each ref.

**Response:**
```json
{
  "status": "success",
  "message": "Refs retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "refs": [
    {
      "ref": "https://example.com",
      "count": 3,
      "node_ids": ["node-id-1", "node-id-2", "node-id-3"]
    },
    {
      "ref": "roam://node-id-123",
      "count": 2,
      "node_ids": ["node-id-4", "node-id-5"]
    }
  ],
  "total_refs": 2
}
```

### GET /citations
Returns a list of all unique citations used across org-roam nodes with usage counts and the node IDs that use each citation. Supports both `[@citation-key]` and `[[cite:citation-key]]` formats.

**Response:**
```json
{
  "status": "success",
  "message": "Citations retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "citations": [
    {
      "citation": "smith2023",
      "count": 3,
      "node_ids": ["node-id-1", "node-id-2", "node-id-3"]
    },
    {
      "citation": "jones2022methodology",
      "count": 1,
      "node_ids": ["node-id-4"]
    }
  ],
  "total_citations": 2
}
```

### GET /tags/:tag/nodes
Returns a list of nodes that have the specified tag.

**Parameters:**
- `tag` (path parameter) - The tag name to filter by

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 2 nodes with tag 'research'",
  "timestamp": "2024-01-01 12:00:00",
  "tag": "research",
  "nodes": [
    {
      "id": "node-id-1",
      "title": "Research Paper 1",
      "file": "/path/to/file1.md",
      "level": 0,
      "tags": ["research", "academic"],
      "aliases": ["Paper 1"]
    },
    {
      "id": "node-id-2", 
      "title": "Research Notes",
      "file": "/path/to/file2.md",
      "level": 0,
      "tags": ["research", "notes"],
      "aliases": null
    }
  ],
  "count": 2
}
```

**Response (No matches):**
```json
{
  "status": "success",
  "message": "No nodes found with tag 'nonexistent'",
  "timestamp": "2024-01-01 12:00:00",
  "tag": "nonexistent",
  "nodes": [],
  "count": 0
}
```

### GET /search/:query
Search for nodes by title or alias matching the query string (case-insensitive partial match).

**Parameters:**
- `query` (path parameter) - The search query string (URL-encoded)

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 2 nodes matching 'research'",
  "timestamp": "2024-01-01 12:00:00",
  "query": "research",
  "nodes": [
    {
      "id": "node-id-1",
      "title": "Research Paper 1",
      "file": "/path/to/file1.md",
      "level": 0,
      "tags": ["research", "academic"],
      "aliases": ["Paper 1"]
    },
    {
      "id": "node-id-2", 
      "title": "My Notes",
      "file": "/path/to/file2.md",
      "level": 0,
      "tags": ["notes"],
      "aliases": ["Research Notes"]
    }
  ],
  "count": 2
}
```

**Response (No matches):**
```json
{
  "status": "success",
  "message": "No nodes found matching 'nonexistent'",
  "timestamp": "2024-01-01 12:00:00",
  "query": "nonexistent",
  "nodes": [],
  "count": 0
}
```

### GET /nodes
Returns a list of all org-roam nodes with metadata, ordered by title.

**Response (Success):**
```json
{
  "status": "success",
  "message": "Retrieved 3 nodes successfully",
  "timestamp": "2024-01-01 12:00:00",
  "nodes": [
    {
      "id": "node-id-1",
      "title": "First Node",
      "file": "relative/path/to/file1.md",
      "level": 0,
      "tags": ["tag1", "tag2"],
      "aliases": ["alias1"]
    },
    {
      "id": "node-id-2",
      "title": "Second Node",
      "file": "relative/path/to/file2.md",
      "level": 0,
      "tags": ["tag3"],
      "aliases": []
    }
  ],
  "count": 2
}
```

**Response (No nodes):**
```json
{
  "status": "success",
  "message": "No nodes found",
  "timestamp": "2024-01-01 12:00:00",
  "nodes": [],
  "count": 0
}
```

### GET /nodes/:id
Returns a single org-roam node by its ID.

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Response (200 - Success):**
```json
{
  "status": "success",
  "message": "Node retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "id": "node-id",
  "title": "Node Title",
  "file": "/path/to/file.org",
  "level": 0,
  "tags": ["tag1", "tag2"],
  "aliases": ["alias1"]
}
```

**Response (404 - Not Found):**
```json
{
  "status": "error",
  "message": "Node with ID 'invalid-id' not found",
  "timestamp": "2024-01-01 12:00:00"
}
```

### GET /nodes/:id/content
Returns the full file content of a single org-roam node by its ID, including all metadata.

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Response (Success):**
```json
{
  "status": "success",
  "message": "File content retrieved successfully for node: Node Title",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "title": "Node Title",
  "file_path": "relative/path/to/file.md",
  "full_path": "/full/path/to/file.md",
  "level": 0,
  "size": 1024,
  "modified": "2024-01-01 10:30:00",
  "tags": ["tag1", "tag2"],
  "aliases": ["alias1"],
  "content": "# Node Title\n\nThis is the full content of the file..."
}
```

**Response (404 - Not Found):**
```json
{
  "status": "error",
  "message": "Node not found: invalid-id",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "invalid-id"
}
```

### GET /nodes/:id/parse
Parses a node file and returns separated metadata and body content. Supports both Markdown (YAML front matter) and Org mode (properties drawer and #+KEYWORD: format) files with a unified response format.

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Response (Success):**
```json
{
  "status": "success",
  "message": "File parsed successfully for node: Node Title",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "title": "Node Title",
  "file_path": "relative/path/to/file.md",
  "full_path": "/full/path/to/file.md",
  "file_type": "md",
  "level": 0,
  "size": 1024,
  "modified": "2024-01-01 10:30:00",
  "tags": ["tag1", "tag2"],
  "aliases": ["alias1"],
  "metadata": [
    {
      "id": "FC4AE1D6-9650-472E-BFD6-F6AF96B13574"
    },
    {
      "title": "Node Title"
    },
    {
      "category": ["test", "example"]
    },
    {
      "roam_refs": "https://example.com"
    }
  ],
  "body": "# Node Title\n\nThis is the body content after metadata..."
}
```

**Supported File Formats:**

- **Markdown (.md)**: YAML front matter between `---` delimiters
- **Org mode (.org)**: Properties drawer (`:PROPERTIES:` ... `:END:`) and `#+KEYWORD:` format

**Response (404 - Not Found):**
```json
{
  "status": "error",
  "message": "Node not found: invalid-id",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "invalid-id"
}
```

### GET /nodes/:id/aliases
Returns the aliases for a single org-roam node by its ID.

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 2 aliases for node 'Research Paper 1'",
  "timestamp": "2024-01-01 12:00:00",
  "id": "node-id",
  "title": "Research Paper 1",
  "aliases": ["Paper 1", "Research Doc"],
  "count": 2
}
```

**Response (No aliases):**
```json
{
  "status": "success",
  "message": "No aliases found for node 'Simple Note'",
  "timestamp": "2024-01-01 12:00:00",
  "id": "node-id",
  "title": "Simple Note",
  "aliases": [],
  "count": 0
}
```

**Response (404 - Not Found):**
```json
{
  "status": "error",
  "message": "Node with ID 'invalid-id' not found",
  "timestamp": "2024-01-01 12:00:00"
}
```

### GET /nodes/:id/refs
Returns the refs for a single org-roam node by its ID.

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 3 refs for node 'Research Paper 1'",
  "timestamp": "2024-01-01 12:00:00",
  "id": "node-id",
  "title": "Research Paper 1",
  "refs": [
    "https://example.com",
    "https://github.com/user/repo",
    "roam://another-node-id"
  ],
  "count": 3
}
```

**Response (No refs):**
```json
{
  "status": "success",
  "message": "No refs found for node 'Simple Note'",
  "timestamp": "2024-01-01 12:00:00",
  "id": "node-id",
  "title": "Simple Note",
  "refs": [],
  "count": 0
}
```

**Response (404 - Not Found):**
```json
{
  "status": "error",
  "message": "Node with ID 'invalid-id' not found",
  "timestamp": "2024-01-01 12:00:00"
}
```

### POST /sync
Synchronizes the org-roam database by scanning for new or modified files.

**Response:**
```json
{
  "status": "success",
  "message": "Database sync completed",
  "initial_count": 2,
  "final_count": 3,
  "nodes_changed": 1,
  "directory": "/Users/user/org-roam",
  "timestamp": "2024-01-01 12:00:00"
}
```

### POST /nodes
Creates a new md-roam node (Markdown file) with the specified title, category, tags, content, aliases, and references.

**Request Body:**
```json
{
  "title": "My New Note",
  "category": "#research #important",
  "tags": ["tag1", "tag2"],
  "aliases": ["Alternative Name", "Short Name"],
  "refs": ["https://example.com", "https://github.com/user/repo"],
  "content": "Initial content for the note."
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Node created successfully",
  "id": "unique-node-id",
  "title": "My New Note",
  "file": "/path/to/new/file.md",
  "category": "#research #important",
  "tags": ["tag1", "tag2"],
  "aliases": ["Alternative Name", "Short Name"],
  "refs": ["https://example.com", "https://github.com/user/repo"],
  "timestamp": "2024-01-01 12:00:00"
}
```

**Generated Markdown File Format:**
```markdown
---
id: unique-node-id
title: My New Note
category: #research #important
roam_aliases: ["Alternative Name", "Short Name"]
roam_refs: https://example.com https://github.com/user/repo
---

#tag1 #tag2

Initial content for the note.
```

### PUT /nodes/:id
Updates an existing org-roam node with new content and metadata.

**Parameters:**
- `id` (path parameter) - The unique ID of the node to update

**Request Body:**
```json
{
  "title": "Updated Node Title",
  "category": "#updated #category",
  "tags": ["new-tag1", "new-tag2"],
  "aliases": ["New Alias"],
  "refs": ["https://updated.example.com"],
  "content": "Updated content for the node."
}
```

**Response (Success):**
```json
{
  "status": "success",
  "message": "Node updated successfully: Updated Node Title",
  "timestamp": "2024-01-01 12:00:00",
  "id": "node-id",
  "title": "Updated Node Title",
  "file": "relative/path/to/file.md",
  "category": "#updated #category",
  "tags": ["new-tag1", "new-tag2"],
  "aliases": ["New Alias"],
  "refs": ["https://updated.example.com"]
}
```

### DELETE /nodes/:id
Deletes an org-roam node and its associated file.

**Parameters:**
- `id` (path parameter) - The unique ID of the node to delete

**Response (Success):**
```json
{
  "status": "success",
  "message": "Node deleted successfully: Node Title",
  "timestamp": "2024-01-01 12:00:00",
  "id": "node-id",
  "title": "Node Title",
  "file": "relative/path/to/file.md"
}
```

### GET /nodes/:id/backlinks
Returns all nodes that link to the specified node (backlinks).

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 2 backlinks for node",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "target-node-id",
  "backlinks": [
    {
      "id": "source-node-1",
      "title": "Source Node 1",
      "file": "path/to/source1.md",
      "level": 0,
      "link_type": "id"
    },
    {
      "id": "source-node-2", 
      "title": "Source Node 2",
      "file": "path/to/source2.md",
      "level": 0,
      "link_type": "id"
    }
  ],
  "count": 2
}
```

### GET /nodes/:id/links
Returns all nodes that the specified node links to (forward links).

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 1 forward links from node",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "source-node-id",
  "links": [
    {
      "id": "target-node-id",
      "title": "Target Node",
      "file": "path/to/target.md",
      "level": 0,
      "link_type": "id"
    }
  ],
  "count": 1
}
```

### GET /aliases/:alias/nodes
Returns all nodes that have the specified alias.

**Parameters:**
- `alias` (path parameter) - The alias to search for

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 1 nodes with alias 'MyAlias'",
  "timestamp": "2024-01-01 12:00:00",
  "alias": "MyAlias",
  "nodes": [
    {
      "id": "node-id",
      "title": "Node Title",
      "file": "path/to/file.md",
      "level": 0,
      "tags": ["tag1"],
      "aliases": ["MyAlias", "OtherAlias"]
    }
  ],
  "count": 1
}
```

### GET /refs/:ref/nodes  
Returns all nodes that reference the specified URL.

**Parameters:**
- `ref` (path parameter, URL-encoded) - The reference URL to search for

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 2 nodes with ref 'https://example.com'",
  "timestamp": "2024-01-01 12:00:00",
  "ref": "https://example.com",
  "nodes": [
    {
      "id": "node-id-1",
      "title": "Research Paper",
      "file": "research/paper.md",
      "level": 0,
      "tags": ["research"],
      "aliases": []
    }
  ],
  "count": 1
}
```

### GET /citations/:citation/nodes
Returns all nodes that contain the specified citation.

**Parameters:**
- `citation` (path parameter) - The citation key to search for

**Response (Success):**
```json
{
  "status": "success",
  "message": "Found 1 nodes with citation 'smith2023'",
  "timestamp": "2024-01-01 12:00:00", 
  "citation": "smith2023",
  "nodes": [
    {
      "id": "node-id",
      "title": "Literature Review",
      "file": "reviews/literature.md",
      "level": 0,
      "tags": ["literature", "review"],
      "aliases": []
    }
  ],
  "count": 1
}
```

### GET /stats
Returns comprehensive statistics about the org-roam database.

**Response (Success):**
```json
{
  "status": "success",
  "message": "Statistics retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "total_nodes": 150,
  "total_links": 320,
  "total_tags": 45,
  "total_aliases": 28,
  "total_refs": 67,
  "total_citations": 89,
  "file_types": {
    "md": 120,
    "org": 30
  },
  "avg_links_per_node": 2.13
}
```

### GET /config
Returns current server configuration settings.

**Response (Success):**
```json
{
  "status": "success",
  "message": "Configuration retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "config_file": "/Users/user/.config/md-roam-server/config.yml",
  "server": {
    "port": 8080,
    "ui_port": 35901,
    "ui_enabled": true
  },
  "org_roam": {
    "directory": "/Users/user/org-roam/",
    "db_location": "/Users/user/org-roam/org-roam.db",
    "db_exists": true
  },
  "config_source": {
    "server": {
      "port": 8080,
      "ui-port": 35901,
      "ui-enabled": true
    },
    "org-roam": {
      "directory": "~/org-roam"
    }
  }
}
```

### POST /nodes/:id/tags
Adds a tag to a specific node by updating the file content.

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Request Body:**
```json
{
  "tag": "new-tag"
}
```

**Response (Success):**
```json
{
  "status": "success",
  "message": "Tag 'new-tag' added to node 'Node Title'",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "title": "Node Title",
  "tag_added": "new-tag",
  "current_tags": ["existing-tag", "new-tag"]
}
```

**Response (Tag Already Exists):**
```json
{
  "status": "error",
  "message": "Tag 'existing-tag' already exists on node 'Node Title'",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "tag": "existing-tag",
  "existing_tags": ["existing-tag"]
}
```

### DELETE /nodes/:id/tags/:tag
Removes a specific tag from a node by updating the file content.

**Parameters:**
- `id` (path parameter) - The unique ID of the node
- `tag` (path parameter) - The tag to remove

**Response (Success):**
```json
{
  "status": "success", 
  "message": "Tag 'old-tag' removed from node 'Node Title'",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "title": "Node Title",
  "tag_removed": "old-tag",
  "current_tags": ["remaining-tag"]
}
```

**Response (Tag Not Found):**
```json
{
  "status": "error",
  "message": "Tag 'nonexistent-tag' does not exist on node 'Node Title'",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "tag": "nonexistent-tag",
  "existing_tags": ["existing-tag"]
}
```

### POST /nodes/:id/categories
Adds a category to a specific node by updating the `category:` field in the file content.

**Parameters:**
- `id` (path parameter) - The unique ID of the node

**Request Body:**
```json
{
  "category": "new-category"
}
```

**Response (Success):**
```json
{
  "status": "success",
  "message": "Category 'new-category' added to node 'Node Title'",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "title": "Node Title",
  "category_added": "new-category",
  "current_categories": ["existing-category", "new-category"]
}
```

**Response (Category Already Exists):**
```json
{
  "status": "error",
  "message": "Category 'existing-category' already exists on node 'Node Title'",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "category": "existing-category",
  "existing_categories": ["existing-category"]
}
```

### DELETE /nodes/:id/categories/:category
Removes a specific category from a node by updating the `category:` field in the file content.

**Parameters:**
- `id` (path parameter) - The unique ID of the node
- `category` (path parameter) - The category to remove

**Response (Success):**
```json
{
  "status": "success", 
  "message": "Category 'old-category' removed from node 'Node Title'",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "title": "Node Title",
  "category_removed": "old-category",
  "current_categories": ["remaining-category"]
}
```

**Response (Category Not Found):**
```json
{
  "status": "error",
  "message": "Category 'nonexistent-category' does not exist on node 'Node Title'",
  "timestamp": "2024-01-01 12:00:00",
  "node_id": "node-id",
  "category": "nonexistent-category",
  "existing_categories": ["existing-category"]
}
```

## Server Status

Check server status and health:
```bash
# Check if server is running
curl -s http://localhost:8080/stats

# Check UI status
curl -s http://localhost:8080/ui

# Monitor server processes
ps aux | grep emacs
lsof -i:8080,35901
```

## Testing

The project includes comprehensive E2E tests that use a dedicated test configuration. Test files are created in the project's `tmp/org-roam` directory to avoid interfering with your actual org-roam data.

### Test Configuration

Tests use a separate configuration file (`tests/config/test-config.yml`) that:
- Sets the org-roam directory to `./tmp/org-roam` (within the project)
- Creates test files in an isolated environment
- Automatically cleans up test artifacts

### Running Tests

```bash
# Run all E2E tests
make test

# Run tests in watch mode
make test-watch

# Run tests with coverage report
make test-coverage

# Clean up test artifacts
make test-clean
```

### Test Directory Structure

```
project/
├── tmp/                    # Test artifacts (gitignored)
│   └── org-roam/          # Test org-roam directory
│       ├── org-roam.db    # Test database
│       └── *.org          # Test org files
├── tests/
│   ├── config/
│   │   └── test-config.yml # Test configuration
│   └── e2e/               # Test files
```

### Test Environment

- **Server Port**: 8080 (same as development)
- **UI Port**: 35901 (same as development)
- **Data Directory**: `./tmp/org-roam` (isolated from your data)
- **Configuration**: `tests/config/test-config.yml`

Test the endpoints with curl:
```bash
# Files endpoint
curl http://localhost:8080/files

# Raw files listing endpoint
curl http://localhost:8080/files/raw

# File content endpoint
curl http://localhost:8080/files/content/20250823014345-corrected_alias_format.md

# Tags endpoint (includes node IDs)
curl http://localhost:8080/tags

# Aliases endpoint (includes node IDs)
curl http://localhost:8080/aliases

# Refs endpoint (includes node IDs)
curl http://localhost:8080/refs

# Citations endpoint (includes node IDs)
curl http://localhost:8080/citations

# Get nodes by tag endpoint  
curl http://localhost:8080/tags/research/nodes

# Search nodes by title or alias endpoint
curl http://localhost:8080/search/research
curl "http://localhost:8080/search/Study%20Note"

# Get all nodes endpoint
curl http://localhost:8080/nodes

# Get single node by ID endpoint
curl http://localhost:8080/nodes/YOUR_NODE_ID

# Get node file content by ID endpoint
curl http://localhost:8080/nodes/YOUR_NODE_ID/content

# Parse node file (metadata and body) by ID endpoint
curl http://localhost:8080/nodes/YOUR_NODE_ID/parse

# Get node aliases by ID endpoint
curl http://localhost:8080/nodes/YOUR_NODE_ID/aliases

# Get node refs by ID endpoint
curl http://localhost:8080/nodes/YOUR_NODE_ID/refs

# Sync database endpoint
curl -X POST http://localhost:8080/sync

# Update node endpoint
curl -X PUT http://localhost:8080/nodes/YOUR_NODE_ID \
  -H "Content-Type: application/json" \
  -d '{"title": "Updated Title", "category": "#updated", "tags": ["updated"], "content": "Updated content."}'

# Delete node endpoint
curl -X DELETE http://localhost:8080/nodes/YOUR_NODE_ID

# Get node backlinks endpoint
curl http://localhost:8080/nodes/YOUR_NODE_ID/backlinks

# Get node forward links endpoint
curl http://localhost:8080/nodes/YOUR_NODE_ID/links

# Get nodes by alias endpoint
curl http://localhost:8080/aliases/MyAlias/nodes

# Get nodes by ref endpoint (URL-encoded)
curl "http://localhost:8080/refs/https%3A%2F%2Fexample.com/nodes"

# Get nodes by citation endpoint
curl http://localhost:8080/citations/smith2023/nodes

# Get database statistics endpoint
curl http://localhost:8080/stats

# Get server configuration endpoint
curl http://localhost:8080/config

# Add tag to node endpoint
curl -X POST http://localhost:8080/nodes/YOUR_NODE_ID/tags \
  -H "Content-Type: application/json" \
  -d '{"tag": "new-tag"}'

# Remove tag from node endpoint
curl -X DELETE http://localhost:8080/nodes/YOUR_NODE_ID/tags/old-tag

# Add category to node endpoint
curl -X POST http://localhost:8080/nodes/YOUR_NODE_ID/categories \
  -H "Content-Type: application/json" \
  -d '{"category": "new-category"}'

# Remove category from node endpoint
curl -X DELETE http://localhost:8080/nodes/YOUR_NODE_ID/categories/old-category

# Create new node endpoint - Markdown (full metadata support)
curl -X POST http://localhost:8080/nodes \
  -H "Content-Type: application/json" \
  -d '{"title": "Test Note", "content": "This is a test note.", "tags": ["test"], "aliases": ["Testing"], "refs": ["https://example.com"], "category": "testing", "file_type": "md"}'

# Create new node endpoint - Org file (basic metadata support) 
curl -X POST http://localhost:8080/nodes \
  -H "Content-Type: application/json" \
  -d '{"title": "Org Note", "content": "This is an org note.", "tags": ["org"], "category": "testing", "file_type": "org"}'

# Create simple node (defaults to Markdown)
curl -X POST http://localhost:8080/nodes \
  -H "Content-Type: application/json" \
  -d '{"title": "Simple Note", "content": "Basic content"}'

```

## OpenAPI Specification

The server provides a complete OpenAPI 3.0 specification in the `openapi.yml` file located in the project root. This specification documents all available endpoints, request/response schemas, and can be used to generate client libraries or import into API testing tools like Postman or Swagger UI.

**File:** `openapi.yml` (static file in project root)

**Contents:** OpenAPI 3.0 YAML specification including:
- Complete API information (title, version, description)
- All available endpoints with detailed descriptions
- Request/response schemas with examples
- Parameter definitions and validation rules
- Error response formats

The specification can be used with tools like:
- **Swagger UI**: For interactive API documentation (`swagger-ui-serve openapi.yml`)
- **Postman**: Import the OpenAPI spec to generate requests
- **Code generators**: Generate client libraries in various languages
- **API testing tools**: Validate API responses against the schema

To view the specification:
```bash
# View the OpenAPI specification file
cat openapi.yml

# Serve with Swagger UI (if installed)
swagger-ui-serve openapi.yml

# Import into Postman or other API tools
```

## org-roam-ui Integration

The server includes integrated [org-roam-ui](https://github.com/org-roam/org-roam-ui) support for interactive visualization of your knowledge graph. org-roam-ui provides a web-based interface to explore connections between your notes visually.

### Features

- **Interactive Graph**: Visual representation of nodes and their connections
- **Real-time Updates**: Automatically syncs changes from Emacs to the web interface
- **Theme Synchronization**: Matches your Emacs theme in the web interface
- **Navigation**: Click to navigate between related notes
- **Search Integration**: Visual search within the graph interface

### Configuration

org-roam-ui is enabled by default and runs on port 35901. When the server starts, it automatically opens the graph interface in your default browser. The following configuration options are available:

- **UI Server Port**: `md-roam-server-ui-port` (default: 35901)
- **Enable/Disable**: `md-roam-server-ui-enabled` (default: t)
- **Auto-open Browser**: Automatically opens the graph interface on startup (default: enabled)

### Accessing the Interface

Once the server starts, you can access the graph interface at:

```
http://localhost:35901
```

### API Endpoint

Get org-roam-ui status and configuration:

```bash
# Get UI status
curl http://localhost:8080/ui
```

**Response:**
```json
{
  "status": "success",
  "message": "org-roam-ui status retrieved successfully",
  "timestamp": "2024-01-01 12:00:00",
  "ui_enabled": true,
  "ui_port": 35901,
  "ui_url": "http://localhost:35901",
  "ui_running": true,
  "configuration": {
    "sync_theme": true,
    "follow": true,
    "update_on_save": true,
    "open_on_start": true
  }
}
```

## Recent Updates

### File Format Selection Support

The server now supports creating both Markdown (.md) and Org (.org) files with the new `file_type` parameter:

**Key Features:**
- **Markdown Files**: Full metadata support including tags, aliases, refs, and category using YAML front matter
- **Org Files**: Basic metadata support with Properties drawer and org-mode keywords  
- **Default Behavior**: Creates Markdown files when `file_type` is not specified
- **Safe Implementation**: Uses `write-region` with comprehensive error handling for reliable file creation

**Implementation Improvements:**
- Fixed HTTP request parsing for POST requests with JSON payloads
- Added proper UUID v4 generation with version bits
- Comprehensive error handling with condition-case blocks
- Immediate HTTP responses (no more timeouts)
- Safe directory creation and validation

**API Changes:**
- Added `file_type` parameter: `"md"` (default) or `"org"`
- Enhanced error responses with detailed error information
- Improved JSON encoding for metadata arrays (tags, aliases, refs)

This update resolves all previous issues with node creation and provides a robust foundation for both file formats.